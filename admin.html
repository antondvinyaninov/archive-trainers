<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - –¢—Ä–µ–Ω–∞–∂–µ—Ä—ã –ø–æ –∞—Ä—Ö–∏–≤–Ω–æ–º—É –¥–µ–ª—É</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .student-card {
            transition: all 0.3s ease;
        }
        
        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <div class="gradient-bg text-white py-6 mb-8 shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold mb-2">üë®‚Äçüè´ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
                    <p class="opacity-90">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –ø–æ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–∞–º</p>
                </div>
                <div class="text-right">
                    <div id="adminName" class="font-semibold mb-2"></div>
                    <a href="index.html" class="text-sm underline hover:text-white/80">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
                    <span class="mx-2">|</span>
                    <button onclick="logout()" class="text-sm underline hover:text-white/80">–í—ã–π—Ç–∏</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 pb-8">
        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏</label>
                    <input type="text" id="searchInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–ª–∏ —Ñ–∞–º–∏–ª–∏—é..."
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–§–∏–ª—å—Ç—Ä –ø–æ –≥—Ä—É–ø–ø–µ</label>
                    <select id="groupFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        <option value="">–í—Å–µ –≥—Ä—É–ø–ø—ã</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–§–∏–ª—å—Ç—Ä –ø–æ —Ç—Ä–µ–Ω–∞–∂–µ—Ä—É</label>
                    <select id="trainerFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        <option value="">–í—Å–µ —Ç—Ä–µ–Ω–∞–∂–µ—Ä—ã</option>
                        <option value="opis-del">–û–ø–∏—Å—å –¥–µ–ª</option>
                        <option value="arhivnaya-spravka">–ê—Ä—Ö–∏–≤–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞</option>
                        <option value="list-ispolzovaniya">–õ–∏—Å—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</option>
                        <option value="protokol-komissii">–ü—Ä–æ—Ç–æ–∫–æ–ª –∫–æ–º–∏—Å—Å–∏–∏</option>
                        <option value="nomenklatura-del">–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞ –¥–µ–ª</option>
                        <option value="akt-unichtozheniya">–ê–∫—Ç —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è</option>
                        <option value="oblozhka-dela">–û–±–ª–æ–∂–∫–∞ –¥–µ–ª–∞</option>
                    </select>
                </div>
            </div>
            <div class="mt-4 flex gap-4">
                <button onclick="exportToCSV()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition">
                    üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
                </button>
                <button onclick="refreshData()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition">
                    üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                </button>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="text-gray-600 text-sm mb-2">–í—Å–µ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</div>
                <div id="totalStudents" class="text-3xl font-bold text-purple-600">0</div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="text-gray-600 text-sm mb-2">–í—Å–µ–≥–æ –ø–æ–ø—ã—Ç–æ–∫</div>
                <div id="totalAttempts" class="text-3xl font-bold text-blue-600">0</div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="text-gray-600 text-sm mb-2">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</div>
                <div id="totalCompleted" class="text-3xl font-bold text-green-600">0</div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="text-gray-600 text-sm mb-2">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</div>
                <div id="averageScore" class="text-3xl font-bold text-orange-600">0%</div>
            </div>
        </div>

        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
        <div id="loading" class="text-center py-12">
            <div class="loading mx-auto mb-4"></div>
            <p class="text-gray-600">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ -->
        <div id="studentsContainer" class="hidden space-y-4"></div>

        <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
        <div id="emptyState" class="hidden text-center py-12">
            <div class="text-6xl mb-4">üìö</div>
            <h3 class="text-xl font-semibold text-gray-800 mb-2">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
            <p class="text-gray-600">–°—Ç—É–¥–µ–Ω—Ç—ã –µ—â—ë –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ —Ç—Ä–µ–Ω–∞–∂–µ—Ä—ã</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD93IuoTh8YwNYoG7bHkbexYBWWn6M4mh0",
            authDomain: "dasha-70548.firebaseapp.com",
            databaseURL: "https://dasha-70548-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "dasha-70548",
            storageBucket: "dasha-70548.firebasestorage.app",
            messagingSenderId: "525898558720",
            appId: "1:525898558720:web:2bc4cdbabf4dd7056817e5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        let allStudentsData = [];
        let filteredData = [];

        const trainerNames = {
            'opis-del': '–û–ø–∏—Å—å –¥–µ–ª',
            'arhivnaya-spravka': '–ê—Ä—Ö–∏–≤–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞',
            'list-ispolzovaniya': '–õ–∏—Å—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è',
            'protokol-komissii': '–ü—Ä–æ—Ç–æ–∫–æ–ª –∫–æ–º–∏—Å—Å–∏–∏',
            'nomenklatura-del': '–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞ –¥–µ–ª',
            'akt-unichtozheniya': '–ê–∫—Ç —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è',
            'oblozhka-dela': '–û–±–ª–æ–∂–∫–∞ –¥–µ–ª–∞'
        };

        const trainerFields = {
            'opis-del': 11,
            'arhivnaya-spravka': 16,
            'list-ispolzovaniya': 8,
            'protokol-komissii': 10,
            'nomenklatura-del': 15,
            'akt-unichtozheniya': 16,
            'oblozhka-dela': 10
        };

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É');
                window.location.href = 'auth.html';
                return;
            }

            const userRef = ref(database, 'users/' + user.uid);
            const snapshot = await get(userRef);
            
            if (snapshot.exists()) {
                const userData = snapshot.val();
                
                if (userData.role !== 'admin') {
                    alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
                    window.location.href = 'index.html';
                    return;
                }

                document.getElementById('adminName').textContent = `${userData.firstName} ${userData.lastName}`;
                loadAllData();
            }
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
        async function loadAllData() {
            try {
                const usersRef = ref(database, 'users');
                const resultsRef = ref(database, 'results');
                
                const [usersSnapshot, resultsSnapshot] = await Promise.all([
                    get(usersRef),
                    get(resultsRef)
                ]);

                const users = usersSnapshot.val() || {};
                const results = resultsSnapshot.val() || {};

                allStudentsData = [];
                const groups = new Set();

                for (const [uid, userData] of Object.entries(users)) {
                    if (userData.role === 'student') {
                        const studentResults = results[uid] || {};
                        
                        allStudentsData.push({
                            uid,
                            ...userData,
                            results: studentResults
                        });

                        if (userData.group) {
                            groups.add(userData.group);
                        }
                    }
                }

                // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ –≥—Ä—É–ø–ø
                const groupFilter = document.getElementById('groupFilter');
                groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group;
                    groupFilter.appendChild(option);
                });

                filteredData = [...allStudentsData];
                renderStudents();
                updateStatistics();

                document.getElementById('loading').classList.add('hidden');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
        function renderStudents() {
            const container = document.getElementById('studentsContainer');
            const emptyState = document.getElementById('emptyState');

            if (filteredData.length === 0) {
                container.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            container.classList.remove('hidden');
            emptyState.classList.add('hidden');
            container.innerHTML = '';

            filteredData.forEach(student => {
                const card = createStudentCard(student);
                container.appendChild(card);
            });
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞
        function createStudentCard(student) {
            const div = document.createElement('div');
            div.className = 'student-card bg-white rounded-xl shadow-lg p-6';

            const results = student.results || {};
            const trainersCompleted = Object.keys(results).length;
            const totalAttempts = Object.values(results).reduce((sum, r) => sum + (r.attempts || 0), 0);

            let resultsHTML = '';
            for (const [trainerId, result] of Object.entries(results)) {
                const trainerName = trainerNames[trainerId] || trainerId;
                const totalFields = trainerFields[trainerId] || 0;
                const percentage = totalFields > 0 ? Math.round((result.bestScore / totalFields) * 100) : 0;
                const timeStr = result.bestTime ? formatTime(result.bestTime) : '-';
                
                let statusBadge = '';
                if (result.completed) {
                    statusBadge = '<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">‚úì –ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>';
                } else {
                    statusBadge = '<span class="px-2 py-1 bg-yellow-100 text-yellow-700 text-xs rounded-full">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</span>';
                }

                let gradeBadge = '';
                if (result.examGrade) {
                    gradeBadge = `<span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded-full">–≠–∫–∑–∞–º–µ–Ω: ${result.examGrade}</span>`;
                }

                resultsHTML += `
                    <div class="border-t border-gray-200 pt-3 mt-3">
                        <div class="flex justify-between items-start mb-2">
                            <div class="font-medium text-gray-800">${trainerName}</div>
                            <div class="flex gap-2">
                                ${statusBadge}
                                ${gradeBadge}
                            </div>
                        </div>
                        <div class="grid grid-cols-4 gap-4 text-sm">
                            <div>
                                <div class="text-gray-600">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
                                <div class="font-semibold">${result.bestScore || 0}/${totalFields} (${percentage}%)</div>
                            </div>
                            <div>
                                <div class="text-gray-600">–ü–æ–ø—ã—Ç–æ–∫</div>
                                <div class="font-semibold">${result.attempts || 0}</div>
                            </div>
                            <div>
                                <div class="text-gray-600">–õ—É—á—à–µ–µ –≤—Ä–µ–º—è</div>
                                <div class="font-semibold">${timeStr}</div>
                            </div>
                            <div>
                                <div class="text-gray-600">–ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞</div>
                                <div class="font-semibold">${result.lastAttempt ? new Date(result.lastAttempt).toLocaleDateString('ru-RU') : '-'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            if (trainersCompleted === 0) {
                resultsHTML = '<div class="text-center py-4 text-gray-500">–¢—Ä–µ–Ω–∞–∂–µ—Ä—ã –µ—â—ë –Ω–µ –ø—Ä–æ–π–¥–µ–Ω—ã</div>';
            }

            div.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">${student.firstName} ${student.lastName}</h3>
                        <p class="text-gray-600">–ì—Ä—É–ø–ø–∞: ${student.group}</p>
                        <p class="text-sm text-gray-500">${student.email}</p>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-600">–ü—Ä–æ–π–¥–µ–Ω–æ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–æ–≤</div>
                        <div class="text-2xl font-bold text-purple-600">${trainersCompleted}/7</div>
                        <div class="text-xs text-gray-500 mt-1">–í—Å–µ–≥–æ –ø–æ–ø—ã—Ç–æ–∫: ${totalAttempts}</div>
                    </div>
                </div>
                ${resultsHTML}
            `;

            return div;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStatistics() {
            const totalStudents = filteredData.length;
            let totalAttempts = 0;
            let totalCompleted = 0;
            let totalScore = 0;
            let totalMaxScore = 0;

            filteredData.forEach(student => {
                const results = student.results || {};
                Object.values(results).forEach(result => {
                    totalAttempts += result.attempts || 0;
                    if (result.completed) totalCompleted++;
                    totalScore += result.bestScore || 0;
                    
                    // –ù–∞–π—Ç–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–ª –¥–ª—è —ç—Ç–æ–≥–æ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–∞
                    const trainerId = Object.keys(student.results).find(key => student.results[key] === result);
                    totalMaxScore += trainerFields[trainerId] || 0;
                });
            });

            const averagePercentage = totalMaxScore > 0 ? Math.round((totalScore / totalMaxScore) * 100) : 0;

            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('totalAttempts').textContent = totalAttempts;
            document.getElementById('totalCompleted').textContent = totalCompleted;
            document.getElementById('averageScore').textContent = averagePercentage + '%';
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const groupFilter = document.getElementById('groupFilter').value;
            const trainerFilter = document.getElementById('trainerFilter').value;

            filteredData = allStudentsData.filter(student => {
                const matchesSearch = !searchTerm || 
                    student.firstName.toLowerCase().includes(searchTerm) ||
                    student.lastName.toLowerCase().includes(searchTerm);
                
                const matchesGroup = !groupFilter || student.group === groupFilter;
                
                const matchesTrainer = !trainerFilter || 
                    (student.results && student.results[trainerFilter]);

                return matchesSearch && matchesGroup && matchesTrainer;
            });

            renderStudents();
            updateStatistics();
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
        window.exportToCSV = function() {
            let csv = '–§–∞–º–∏–ª–∏—è,–ò–º—è,–ì—Ä—É–ø–ø–∞,Email,–¢—Ä–µ–Ω–∞–∂–µ—Ä,–†–µ–∑—É–ª—å—Ç–∞—Ç,–ü–æ–ø—ã—Ç–æ–∫,–õ—É—á—à–µ–µ –≤—Ä–µ–º—è,–ó–∞–≤–µ—Ä—à–µ–Ω–æ,–û—Ü–µ–Ω–∫–∞ —ç–∫–∑–∞–º–µ–Ω–∞,–ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞\n';

            filteredData.forEach(student => {
                const results = student.results || {};
                if (Object.keys(results).length === 0) {
                    csv += `${student.lastName},${student.firstName},${student.group},${student.email},–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö,,,,,\n`;
                } else {
                    Object.entries(results).forEach(([trainerId, result]) => {
                        const trainerName = trainerNames[trainerId] || trainerId;
                        const totalFields = trainerFields[trainerId] || 0;
                        const timeStr = result.bestTime ? formatTime(result.bestTime) : '-';
                        const completed = result.completed ? '–î–∞' : '–ù–µ—Ç';
                        const grade = result.examGrade || '-';
                        const lastAttempt = result.lastAttempt ? new Date(result.lastAttempt).toLocaleDateString('ru-RU') : '-';
                        
                        csv += `${student.lastName},${student.firstName},${student.group},${student.email},"${trainerName}",${result.bestScore}/${totalFields},${result.attempts},${timeStr},${completed},${grade},${lastAttempt}\n`;
                    });
                }
            });

            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        };

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        window.refreshData = function() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('studentsContainer').classList.add('hidden');
            loadAllData();
        };

        // –í—ã—Ö–æ–¥
        window.logout = async function() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
                await signOut(auth);
                window.location.href = 'auth.html';
            }
        };

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('groupFilter').addEventListener('change', applyFilters);
        document.getElementById('trainerFilter').addEventListener('change', applyFilters);
    </script>
</body>
</html>
